<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School Financial Tracker - Data Entry</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .role-selection {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 50px;
        }
        .role-btn {
            width: 200px;
            height: 200px;
            font-size: 24px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .form-container {
            max-width: 600px;
            margin: 50px auto;
            padding: 30px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .hidden {
            display: none;
        }
        .summary-card {
            margin-bottom: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }
        .summary-card:hover {
            transform: translateY(-5px);
        }
        .card-title {
            color: #6c757d;
            font-size: 1rem;
            font-weight: 600;
        }
        .history-container {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
        }
        .history-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
        }
        .history-item:last-child {
            border-bottom: none;
        }
        .history-date {
            color: #6c757d;
            font-size: 0.85rem;
        }
        .history-amount {
            font-weight: bold;
        }
        .positive-amount {
            color: #28a745;
        }
        .negative-amount {
            color: #dc3545;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Role Selection Screen -->
        <div id="role-selection-screen">
            <h1 class="text-center my-4">School Financial Tracker - Data Entry</h1>
            <div class="role-selection">
                <button id="teacher-btn" class="btn btn-primary role-btn">Teacher</button>
                <button id="admin-btn" class="btn btn-danger role-btn">Admin</button>
            </div>
        </div>

        <!-- Password Screen -->
        <div id="password-screen" class="form-container hidden">
            <h2 class="text-center mb-4">Enter Password</h2>
            <div class="mb-3">
                <label for="password" class="form-label">Password</label>
                <input type="password" class="form-control" id="password" required>
            </div>
            <button id="submit-password" class="btn btn-primary w-100">Continue</button>
        </div>

        <!-- Teacher Sign Up Screen -->
        <div id="signup-screen" class="form-container hidden">
            <h2 class="text-center mb-4">Teacher Sign Up</h2>
            <div class="mb-3">
                <label for="teacher-name" class="form-label">Name</label>
                <input type="text" class="form-control" id="teacher-name" required>
            </div>
            <div class="mb-3">
                <label for="teacher-class" class="form-label">Class</label>
                <select id="teacher-class" class="form-select" required>
                    <option value="">Select Class</option>
                    <option value="Form1">Form 1</option>
                    <option value="Form2">Form 2</option>
                    <option value="Form3">Form 3</option>
                </select>
            </div>
            <button id="submit-signup" class="btn btn-primary w-100">Sign Up</button>
        </div>

        <!-- Teacher Dashboard -->
        <div id="teacher-dashboard" class="hidden">
            <h1 class="text-center my-4">Teacher Dashboard</h1>
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card summary-card">
                        <div class="card-body">
                            <h5 class="card-title">Class Fees Total</h5>
                            <h2 id="class-fees-total">₵0.00</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card summary-card">
                        <div class="card-body">
                            <h5 class="card-title">Printing Fees Total</h5>
                            <h2 id="printing-fees-total">₵0.00</h2>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <h3>Add Class Fee</h3>
                    <div class="mb-3">
                        <input type="number" id="class-fee-amount" class="form-control" placeholder="Amount">
                    </div>
                    <button id="add-class-fee" class="btn btn-primary">Add Fee</button>
                    <div class="history-container" id="class-fees-history">
                        <!-- Class fees history will be loaded here -->
                    </div>
                </div>
                <div class="col-md-6">
                    <h3>Add Printing Fee</h3>
                    <div class="mb-3">
                        <input type="number" id="printing-fee-amount" class="form-control" placeholder="Amount">
                    </div>
                    <button id="add-printing-fee" class="btn btn-primary">Add Printing Fee</button>
                    <div class="history-container" id="printing-fees-history">
                        <!-- Printing fees history will be loaded here -->
                    </div>
                </div>
            </div>

            <div class="row mt-4">
                <div class="col-md-12">
                    <h3>Expenses</h3>
                    <button id="teacher-withdraw-btn" class="btn btn-danger mb-3">Make Withdrawal</button>
                    <div class="history-container" id="teacher-expenses-history">
                        <!-- Expenses history will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Withdrawal Modal -->
        <div class="modal fade" id="withdrawModal" tabindex="-1" aria-labelledby="withdrawModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="withdrawModalLabel">Make Withdrawal</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="withdrawal-form">
                            <div class="mb-3">
                                <label for="withdraw-amount" class="form-label">Amount</label>
                                <input type="number" class="form-control" id="withdraw-amount" name="withdraw_amount" required>
                            </div>
                            <div class="mb-3">
                                <label for="withdraw-reason" class="form-label">Reason</label>
                                <textarea class="form-control" id="withdraw-reason" name="withdraw_reason" rows="3" required></textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-danger" id="confirm-withdraw">Confirm Withdrawal</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <script>
        // Firebase configuration (same as main site)
        const firebaseConfig = {
            apiKey: "AIzaSyAtELW6wBsFVMYBOyNd8UgO5YxSjMk0VCI",
            authDomain: "fees-tracker-hwe.firebaseapp.com",
            databaseURL: "https://fees-tracker-hwe-default-rtdb.firebaseio.com",
            projectId: "fees-tracker-hwe",
            storageBucket: "fees-tracker-hwe.appspot.com",
            messagingSenderId: "743578133528",
            appId: "1:743578133528:web:fc800970e075c4b4be0f6d",
            measurementId: "G-K0PYH1G62H"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // DOM Elements
        const roleSelectionScreen = document.getElementById('role-selection-screen');
        const passwordScreen = document.getElementById('password-screen');
        const signupScreen = document.getElementById('signup-screen');
        const teacherDashboard = document.getElementById('teacher-dashboard');
        const teacherBtn = document.getElementById('teacher-btn');
        const adminBtn = document.getElementById('admin-btn');
        const passwordInput = document.getElementById('password');
        const submitPasswordBtn = document.getElementById('submit-password');
        const teacherNameInput = document.getElementById('teacher-name');
        const teacherClassSelect = document.getElementById('teacher-class');
        const submitSignupBtn = document.getElementById('submit-signup');
        const classFeesTotal = document.getElementById('class-fees-total');
        const printingFeesTotal = document.getElementById('printing-fees-total');
        const classFeeAmount = document.getElementById('class-fee-amount');
        const addClassFeeBtn = document.getElementById('add-class-fee');
        const printingFeeAmount = document.getElementById('printing-fee-amount');
        const addPrintingFeeBtn = document.getElementById('add-printing-fee');
        const teacherWithdrawBtn = document.getElementById('teacher-withdraw-btn');
        const confirmWithdrawBtn = document.getElementById('confirm-withdraw');
        const withdrawAmount = document.getElementById('withdraw-amount');
        const withdrawReason = document.getElementById('withdraw-reason');

        // State variables
        let currentTeacher = null;
        let currentClass = null;
        let isAdmin = false;

        // Function to format date
        function formatDate(timestamp) {
            const date = new Date(timestamp);
            const options = { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };
            return date.toLocaleDateString('en-US', options);
        }

        // Function to format currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-GH', { style: 'currency', currency: 'GHS' }).format(amount);
        }

        // Function to show screen and hide others
        function showScreen(screen) {
            document.querySelectorAll('.form-container, #role-selection-screen, #teacher-dashboard').forEach(el => {
                el.classList.add('hidden');
            });
            screen.classList.remove('hidden');
        }

        // Function to load class fees for the selected class
        function loadClassFees() {
            const classFeesHistory = document.getElementById('class-fees-history');
            classFeesHistory.innerHTML = '';
            
            database.ref('classFees').orderByChild('className').equalTo(currentClass).once('value', (snapshot) => {
                let total = 0;
                
                snapshot.forEach((childSnapshot) => {
                    const fee = childSnapshot.val();
                    if (!fee.deleted) {
                        total += parseFloat(fee.amount) || 0;
                        
                        const historyItem = document.createElement('div');
                        historyItem.className = 'history-item';
                        
                        historyItem.innerHTML = `
                            <div>
                                <div class="history-date">${formatDate(fee.date)}</div>
                            </div>
                            <div class="history-amount positive-amount">+${formatCurrency(fee.amount || 0)}</div>
                        `;
                        
                        classFeesHistory.prepend(historyItem);
                    }
                });
                
                classFeesTotal.textContent = formatCurrency(total);
            });
        }

        // Function to load printing fees for the selected class
        function loadPrintingFees() {
            const printingFeesHistory = document.getElementById('printing-fees-history');
            printingFeesHistory.innerHTML = '';
            
            database.ref('printingFees').orderByChild('className').equalTo(currentClass).once('value', (snapshot) => {
                let total = 0;
                
                snapshot.forEach((childSnapshot) => {
                    const fee = childSnapshot.val();
                    if (!fee.deleted) {
                        total += parseFloat(fee.amount) || 0;
                        
                        const historyItem = document.createElement('div');
                        historyItem.className = 'history-item';
                        
                        historyItem.innerHTML = `
                            <div>
                                <div class="history-date">${formatDate(fee.date)}</div>
                            </div>
                            <div class="history-amount positive-amount">+${formatCurrency(fee.amount || 0)}</div>
                        `;
                        
                        printingFeesHistory.prepend(historyItem);
                    }
                });
                
                printingFeesTotal.textContent = formatCurrency(total);
            });
        }

        // Function to load expenses
        function loadExpenses() {
            const expensesHistory = document.getElementById('teacher-expenses-history');
            expensesHistory.innerHTML = '';
            
            database.ref('Expenses').orderByChild('date').once('value', (snapshot) => {
                snapshot.forEach((childSnapshot) => {
                    const withdrawal = childSnapshot.val();
                    if (!withdrawal.deleted) {
                        const historyItem = document.createElement('div');
                        historyItem.className = 'history-item';
                        
                        historyItem.innerHTML = `
                            <div>
                                <div class="history-date">${formatDate(withdrawal.date)}</div>
                                <div>Reason: ${withdrawal.reason || 'N/A'}</div>
                            </div>
                            <div class="history-amount negative-amount">-${formatCurrency(withdrawal.amount || 0)}</div>
                        `;
                        
                        expensesHistory.prepend(historyItem);
                    }
                });
            });
        }

        // Role selection
        teacherBtn.addEventListener('click', () => {
            isAdmin = false;
            showScreen(passwordScreen);
        });

        adminBtn.addEventListener('click', () => {
            isAdmin = true;
            showScreen(passwordScreen);
        });

        // Password submission
        submitPasswordBtn.addEventListener('click', () => {
            const password = passwordInput.value;
            
            if (isAdmin) {
                if (password === "Word@Manni") {
                    // Redirect to main site for admin
                    window.location.href = "index.html";
                } else {
                    alert("Incorrect admin password");
                }
            } else {
                // For teachers, just check if password is not empty
                if (password.trim() === "") {
                    alert("Please enter a password");
                    return;
                }
                
                // Save teacher password to localStorage (not secure, just for demo)
                localStorage.setItem('teacherPassword', password);
                showScreen(signupScreen);
            }
        });

        // Sign up submission
        submitSignupBtn.addEventListener('click', () => {
            const name = teacherNameInput.value.trim();
            const className = teacherClassSelect.value;
            
            if (!name) {
                alert("Please enter your name");
                return;
            }
            
            if (!className) {
                alert("Please select a class");
                return;
            }
            
            // Save teacher info to localStorage
            localStorage.setItem('teacherName', name);
            localStorage.setItem('teacherClass', className);
            
            currentTeacher = name;
            currentClass = className;
            
            // Initialize dashboard
            loadClassFees();
            loadPrintingFees();
            loadExpenses();
            
            showScreen(teacherDashboard);
        });

        // Add class fee
        addClassFeeBtn.addEventListener('click', () => {
            const amount = parseFloat(classFeeAmount.value);
            
            if (isNaN(amount)) {
                alert("Please enter a valid amount");
                return;
            }
            
            const newFee = {
                className: currentClass,
                amount: amount,
                date: Date.now(),
                deleted: false
            };
            
            database.ref('classFees').push(newFee)
                .then(() => {
                    classFeeAmount.value = '';
                    loadClassFees();
                    alert('Class fee added successfully!');
                })
                .catch(error => {
                    alert('Error adding class fee: ' + error.message);
                });
        });

        // Add printing fee
        addPrintingFeeBtn.addEventListener('click', () => {
            const amount = parseFloat(printingFeeAmount.value);
            
            if (isNaN(amount)) {
                alert("Please enter a valid amount");
                return;
            }
            
            const newFee = {
                className: currentClass,
                amount: amount,
                date: Date.now(),
                deleted: false
            };
            
            database.ref('printingFees').push(newFee)
                .then(() => {
                    printingFeeAmount.value = '';
                    loadPrintingFees();
                    alert('Printing fee added successfully!');
                })
                .catch(error => {
                    alert('Error adding printing fee: ' + error.message);
                });
        });

        // Withdraw button
        teacherWithdrawBtn.addEventListener('click', () => {
            const modal = new bootstrap.Modal(document.getElementById('withdrawModal'));
            modal.show();
        });

        // Confirm withdrawal
        confirmWithdrawBtn.addEventListener('click', () => {
            const amount = parseFloat(withdrawAmount.value);
            const reason = withdrawReason.value.trim();
            
            if (isNaN(amount)) {
                alert("Please enter a valid amount");
                return;
            }
            
            if (!reason) {
                alert("Please enter a reason for withdrawal");
                return;
            }
            
            // Get current totals
            let classFeesTotalAmount = 0;
            let printingFeesTotalAmount = 0;
            
            database.ref('classFees').orderByChild('className').equalTo(currentClass).once('value', (snapshot) => {
                snapshot.forEach(child => {
                    const fee = child.val();
                    if (!fee.deleted) {
                        classFeesTotalAmount += parseFloat(fee.amount) || 0;
                    }
                });
                
                database.ref('printingFees').orderByChild('className').equalTo(currentClass).once('value', (printingSnapshot) => {
                    printingSnapshot.forEach(child => {
                        const fee = child.val();
                        if (!fee.deleted) {
                            printingFeesTotalAmount += parseFloat(fee.amount) || 0;
                        }
                    });
                    
                    const totalAvailable = classFeesTotalAmount + printingFeesTotalAmount;
                    
                    if (amount > totalAvailable) {
                        alert(`Withdrawal amount cannot exceed available funds of ${formatCurrency(totalAvailable)}`);
                        return;
                    }
                    
                    const newWithdrawal = {
                        source: `${currentClass} Funds`,
                        amount: amount,
                        reason: reason,
                        previousBalance: totalAvailable,
                        newBalance: totalAvailable - amount,
                        date: Date.now(),
                        deleted: false
                    };
                    
                    database.ref('Expenses').push(newWithdrawal)
                        .then(() => {
                            withdrawAmount.value = '';
                            withdrawReason.value = '';
                            
                            const modal = bootstrap.Modal.getInstance(document.getElementById('withdrawModal'));
                            modal.hide();
                            
                            loadExpenses();
                            loadClassFees();
                            loadPrintingFees();
                            
                            alert('Withdrawal successful!');
                        })
                        .catch(error => {
                            alert('Error making withdrawal: ' + error.message);
                        });
                });
            });
        });

        // Check if teacher is already signed in
        function checkExistingSession() {
            const teacherName = localStorage.getItem('teacherName');
            const teacherClass = localStorage.getItem('teacherClass');
            
            if (teacherName && teacherClass) {
                currentTeacher = teacherName;
                currentClass = teacherClass;
                
                // Initialize dashboard
                loadClassFees();
                loadPrintingFees();
                loadExpenses();
                
                showScreen(teacherDashboard);
            } else {
                showScreen(roleSelectionScreen);
            }
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Bootstrap modal
            const withdrawModal = new bootstrap.Modal(document.getElementById('withdrawModal'));
            
            // Check for existing session
            checkExistingSession();
        });
    </script>
</body>
</html>
